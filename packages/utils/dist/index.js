"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});function B(t,e=1e3){let r=!1,n,s=1e3;e&&(s=e);const a=async()=>{try{await t()}finally{r&&(n=setTimeout(()=>{clearTimeout(n),a()},s))}};return{start:()=>{if(r)throw new Error("ready start!");r=!0,a()},stop:()=>r=!1,refresh:a,setTime:u=>{s=u}}}function F({cb:t,retryCount:e,intervalTime:r,event:n}){let s=!1,a=!1,i=()=>{};return{promise:new Promise(async(l,u)=>{i=()=>{if(s==!0)return;e=0,a=!0,s=!0;const f="Because of reason [user cancel], re-execute end";return console.warn(f),n(f),u(new Error(f))};const S=async()=>{try{const f=await t();s=!0,l(f)}catch(f){if(a)return;let h="";f instanceof Error?h=f.message:h=JSON.stringify(f);const g=`Because of reason [${h}], start re-execute on ${e}`;if(console.warn(g),n(g),e==0){const y=`Because of reason [${h}], re-execute end`;console.error(y),n(y),s=!0,u(f)}else e!==0&&(e>0&&e--,setTimeout(()=>{S()},r))}};S()}),cancel:i}}function z(t,e){let r=i=>{},n;e&&(n=setTimeout(()=>{r("execute function timeout")},e));const s=new Promise((i,o)=>{r=(l="promise aborted")=>{o(new G(l))}});return{promise:Promise.race([t,s]).then(i=>(n&&(clearTimeout(n),n=void 0),i)),abort:r}}class G extends Error{constructor(e){super(e)}}function m(t){return t&&(Array.isArray(t)?t.map(e=>m(e)):t instanceof Date?new Date(t):typeof t=="object"?Object.fromEntries(Object.entries(t).map(([e,r])=>[e,m(r)])):t)}function U(t){const e=m(t);return{data:t,defaultData:e,getClone:()=>m(e)}}class C{constructor(e){this.events={},e.forEach(r=>{Reflect.set(this.events,r,[])})}addEventListener(e,r){if(!Reflect.has(this.events,e))throw new Error(`event ${e} doesn't exist!`);this.events[e].includes(r)||this.events[e].push(r)}removeEventListener(e,r){if(!Reflect.has(this.events,e))throw new Error(`event ${e} doesn't exist!`);const n=this.events[e].indexOf(r);n!==-1&&this.events[e].splice(n,1)}dispatchEvent(e,r){if(!Reflect.has(this.events,e))throw new Error(`event ${e} doesn't exist!`);this.events[e].forEach(n=>n(r))}}function D(t={},e={}){let r;for(r in e)t[r]=_(t[r])?D(t[r],e[r]):t[r]=e[r];return t}function _(t){return Object.prototype.toString.call(t)==="[object Object]"}var q=typeof global=="object"&&global&&global.Object===Object&&global,H=typeof self=="object"&&self&&self.Object===Object&&self,R=q||H||Function("return this")(),v=R.Symbol,k=Object.prototype,J=k.hasOwnProperty,X=k.toString,b=v?v.toStringTag:void 0;function K(t){var e=J.call(t,b),r=t[b];try{t[b]=void 0;var n=!0}catch{}var s=X.call(t);return n&&(e?t[b]=r:delete t[b]),s}var Q=Object.prototype,V=Q.toString;function Y(t){return V.call(t)}var Z="[object Null]",N="[object Undefined]",L=v?v.toStringTag:void 0;function tt(t){return t==null?t===void 0?N:Z:L&&L in Object(t)?K(t):Y(t)}function et(t){return t!=null&&typeof t=="object"}var rt="[object Symbol]";function nt(t){return typeof t=="symbol"||et(t)&&tt(t)==rt}var st=/\s/;function it(t){for(var e=t.length;e--&&st.test(t.charAt(e)););return e}var at=/^\s+/;function ot(t){return t&&t.slice(0,it(t)+1).replace(at,"")}function x(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}var I=NaN,ct=/^[-+]0x[0-9a-f]+$/i,lt=/^0b[01]+$/i,ft=/^0o[0-7]+$/i,ut=parseInt;function $(t){if(typeof t=="number")return t;if(nt(t))return I;if(x(t)){var e=typeof t.valueOf=="function"?t.valueOf():t;t=x(e)?e+"":e}if(typeof t!="string")return t===0?t:+t;t=ot(t);var r=lt.test(t);return r||ft.test(t)?ut(t.slice(2),r?2:8):ct.test(t)?I:+t}var j=function(){return R.Date.now()},ht="Expected a function",dt=Math.max,gt=Math.min;function mt(t,e,r){var n,s,a,i,o,l,u=0,S=!1,f=!1,h=!0;if(typeof t!="function")throw new TypeError(ht);e=$(e)||0,x(r)&&(S=!!r.leading,f="maxWait"in r,a=f?dt($(r.maxWait)||0,e):a,h="trailing"in r?!!r.trailing:h);function g(c){var d=n,p=s;return n=s=void 0,u=c,i=t.apply(p,d),i}function y(c){return u=c,o=setTimeout(T,e),S?g(c):i}function W(c){var d=c-l,p=c-u,w=e-d;return f?gt(w,a-p):w}function O(c){var d=c-l,p=c-u;return l===void 0||d>=e||d<0||f&&p>=a}function T(){var c=j();if(O(c))return P(c);o=setTimeout(T,W(c))}function P(c){return o=void 0,h&&n?g(c):(n=s=void 0,i)}function M(){o!==void 0&&clearTimeout(o),u=0,n=l=s=o=void 0}function A(){return o===void 0?i:P(j())}function E(){var c=j(),d=O(c);if(n=arguments,s=this,l=c,d){if(o===void 0)return y(l);if(f)return clearTimeout(o),o=setTimeout(T,e),g(l)}return o===void 0&&(o=setTimeout(T,e)),i}return E.cancel=M,E.flush=A,E}const St={searchParams:{},pageParams:{pageIndex:1,pageSize:10},pageSizes:[10,30,50],list:[],total:0,totalPage:0,getListStatus:"succeed",searchStatus:"succeed",pagingStatus:"succeed"};class pt{constructor({requestFun:e,listState:r}){this.events=new C(["changeState"]),this.addStateChangeListener=n=>this.events.addEventListener("changeState",n),this.removeStateChangeListener=n=>this.events.removeEventListener("changeState",n),this.dispatchStateChangeListener=mt(()=>{const n=m(this.listState);this.events.dispatchEvent("changeState",n)},50),this.setListState=n=>{let s={set:(i,o,l)=>(Reflect.set(i,o,l),this.dispatchStateChangeListener(),!0)};const a=D(St,n);return new Proxy(a,s)},this.getList=()=>new Promise((n,s)=>{this.listState.getListStatus==="loading"&&s(new Error("加载中,请稍等")),this.listState.getListStatus="loading";const a={...this.listState.searchParams,page:this.listState.pageParams};this.requestFun(a).then(i=>{const{list:o,total:l,totalPage:u=0}=i;this.listState.totalPage=u,this.listState.total=l,this.listState.list=o,this.listState.getListStatus="succeed",n(i)}).catch(i=>{console.error(i),this.listState.getListStatus="failed",s(i)})}),this.handleSearch=async()=>{this.listState.searchStatus="loading",this.listState.pageParams.pageIndex=1;try{const n=await this.getList();return this.listState.searchStatus="succeed",n}catch(n){console.error("search get error:"+n),this.listState.searchStatus="failed"}},this.handlePageChange=async({pageIndex:n,pageSize:s})=>{this.listState.pagingStatus="loading",n&&(this.listState.pageParams.pageIndex=n),s&&(this.listState.pageParams.pageSize=s);try{const a=await this.getList();return this.listState.pagingStatus="succeed",a}catch(a){console.error("search get error:"+a),this.listState.pagingStatus="failed"}},this.listState=this.setListState(r),e&&(this.requestFun=e)}}exports.EventsCollect=C;exports.ListInstance=pt;exports.cancelablePromise=z;exports.dataWithDefault=U;exports.deepClone=m;exports.loopFunc=B;exports.reExecute=F;
